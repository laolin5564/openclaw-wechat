# OpenClaw 微信桥接器架构文档

本文档描述了微信桥接器的架构设计、数据流程和技术实现。

---

## 目录

- [系统架构](#系统架构)
- [数据流程](#数据流程)
- [模块设计](#模块设计)
- [错误恢复](#错误恢复)
- [性能考虑](#性能考虑)
- [安全设计](#安全设计)

---

## 系统架构

### 整体架构图

```
┌──────────────────────────────────────────────────────────────────┐
│                              用户设备                               │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌─────────────┐                                                  │
│  │  微信客户端  │                                                  │
│  │   (手机)    │                                                  │
│  └──────┬──────┘                                                  │
│         │                                                          │
│         ▼                                                          │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    微信 iPad 协议服务                        │ │
│  │  ┌──────────────────────────────────────────────────────┐   │ │
│  │  │ - HTTP API (端口 8099)                               │   │ │
│  │  │ - WebSocket 消息推送                                 │   │ │
│  │  │ - SQLite 数据存储                                    │   │ │
│  │  │ - MMTLS 加密通信                                     │   │ │
│  │  └──────────────────────────────────────────────────────┘   │ │
│  └───────────────────────────┬─────────────────────────────────┘ │
│                              │                                      │
│         ┌────────────────────┼────────────────────┐               │
│         │                    │                    │               │
│         ▼                    ▼                    ▼               │
│  ┌─────────────┐    ┌──────────────┐    ┌─────────────┐          │
│  │ HTTP API    │    │  WebSocket   │    │   SQLite    │          │
│  │  (发送消息)  │    │  (接收消息)   │    │  (数据存储)  │          │
│  └─────────────┘    └──────────────┘    └─────────────┘          │
│                              │                                      │
│                              ▼                                      │
│  ┌─────────────────────────────────────────────────────────────┐  │
│  │                   openclaw-wechat 桥接器                     │  │
│  │  ┌──────────────────────────────────────────────────────┐  │  │
│  │  │                    bridge.mjs                        │  │  │
│  │  │  ┌──────────────┐  ┌──────────────┐  ┌────────────┐ │  │  │
│  │  │  │ gateway.mjs  │  │ wechat.mjs   │  │ config.mjs │ │  │  │
│  │  │  │ (Gateway通信)│  │ (微信通信)   │  │ (配置管理) │ │  │  │
│  │  │  └──────────────┘  └──────────────┘  └────────────┘ │  │  │
│  │  │  ┌──────────────┐  ┌──────────────┐                  │  │  │
│  │  │  │ logger.mjs   │  │  utils.mjs   │                  │  │  │
│  │  │  │  (日志模块)  │  │  (工具函数)   │                  │  │  │
│  │  │  └──────────────┘  └──────────────┘                  │  │  │
│  │  └──────────────────────────────────────────────────────┘  │  │
│  └─────────────────────────────────┬───────────────────────────┘ │
│                                    │                              │
└────────────────────────────────────┼──────────────────────────────┘
                                     │
                                     ▼
┌──────────────────────────────────────────────────────────────────┐
│                       OpenClaw Gateway                            │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │  - WebSocket 服务器 (端口 18789)                           │  │
│  │  - 消息路由与分发                                           │  │
│  │  - AI Agent 调用                                            │  │
│  │  - 渠道管理                                                 │  │
│  └────────────────────────────────────────────────────────────┘  │
└────────────────────────────────────┬───────────────────────────────┘
                                     │
                                     ▼
┌──────────────────────────────────────────────────────────────────┐
│                         AI Agent                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐           │
│  │   Claude     │  │     GPT      │  │    其他 AI   │           │
│  └──────────────┘  └──────────────┘  └──────────────┘           │
└──────────────────────────────────────────────────────────────────┘
```

---

## 数据流程

### 用户 → AI 流程

```
1. 用户在微信发送消息
   ↓
2. 微信服务器推送消息
   ↓
3. 微信 iPad 协议服务接收 (WebSocket)
   ↓
4. 桥接器监听并解析消息
   ↓
5. 桥接器转发到 OpenClaw Gateway (WebSocket)
   ↓
6. Gateway 路由到 AI Agent
   ↓
7. AI 处理并生成响应
   ↓
8. 响应返回 Gateway
   ↓
9. Gateway 推送给桥接器 (WebSocket)
   ↓
10. 桥接器调用微信 API 发送消息
   ↓
11. 用户收到 AI 回复
```

### 时序图

```
用户    微信服务    桥接器    Gateway    AI
 │          │          │         │         │
 │  发消息   │          │         │         │
 ├─────────>│          │         │         │
 │          │  推送消息 │         │         │
 │          ├─────────>│         │         │
 │          │          │  转发   │         │
 │          │          ├─────────>│       │
 │          │          │         │  调用   │
 │          │          │         ├────────>│
 │          │          │         │  响应   │
 │          │          │         │<────────┤
 │          │          │  回复   │         │
 │          │          │<─────────┤         │
 │          │  发送API │         │         │
 │          │<─────────┤         │         │
 │  收到回复 │          │         │         │
 │<─────────┤          │         │         │
```

---

## 模块设计

### bridge.mjs - 核心桥接逻辑

**职责**:
- 协调各个模块
- 管理启动/停止流程
- 处理消息路由
- 心跳保活

**主要方法**:
| 方法 | 说明 |
|------|------|
| `init()` | 初始化配置 |
| `start()` | 启动桥接器 |
| `stop()` | 停止桥接器 |
| `handleWechatMessage()` | 处理微信消息 |
| `handleGatewayMessage()` | 处理 Gateway 消息 |

### gateway.mjs - Gateway 通信

**职责**:
- 管理 WebSocket 连接
- 处理请求/响应
- 自动重连

**主要类**:
```javascript
class GatewayConnection {
  connect()           // 连接到 Gateway
  disconnect()        // 断开连接
  request(method, params)  // 发送请求
  sendMessage(from, content)  // 发送消息
  getStatus()         // 获取状态
}
```

### wechat.mjs - 微信服务通信

**职责**:
- HTTP API 调用
- WebSocket 消息监听
- 登录管理

**主要类**:
```javascript
class WechatService {
  getLoginQrCode()    // 获取登录二维码
  getLoginStatus()    // 检查登录状态
  waitForLogin()      // 等待登录完成
  sendTextMessage()   // 发送文本消息
  connectWebSocket()  // 连接 WebSocket
}
```

### config.mjs - 配置管理

**职责**:
- 加载/保存配置
- 管理授权码
- 目录初始化

**主要函数**:
| 函数 | 说明 |
|------|------|
| `loadConfig()` | 加载配置文件 |
| `saveConfig()` | 保存配置文件 |
| `getAuthKey()` | 获取授权码 |
| `saveAuthKey()` | 保存授权码 |

### logger.mjs - 日志模块

**职责**:
- 日志输出
- 日志文件管理
- 彩色控制台输出

**日志级别**:
| 级别 | 说明 |
|------|------|
| `debug` | 调试信息 |
| `info` | 一般信息 |
| `warn` | 警告信息 |
| `error` | 错误信息 |

### utils.mjs - 工具函数

**主要函数**:
| 函数 | 说明 |
|------|------|
| `generateId()` | 生成唯一 ID |
| `delay(ms)` | 延迟执行 |
| `retry(fn, options)` | 带重试的异步函数 |
| `backoffDelay(attempt)` | 指数退避延迟 |
| `parseMessageContent()` | 解析消息内容 |

---

## 错误恢复

### 自动重连机制

```
┌─────────────────────────────────────────────────────┐
│                    错误检测                           │
└─────────────────────────────────────────────────────┘
            │
            ├── Gateway 连接断开
            │   │
            │   ├── 等待 2 秒
            │   ├── 重连 (尝试 1)
            │   ├── 等待 4 秒
            │   ├── 重连 (尝试 2)
            │   ├── ...
            │   └── 最大尝试 10 次后停止
            │
            ├── 微信服务断开
            │   │
            │   ├── 等待 2 秒
            │   ├── 重连 (尝试 1)
            │   ├── 等待 4 秒
            │   ├── 重连 (尝试 2)
            │   └── 持续重连
            │
            └── 微信登录失效
                │
                ├── 停止消息处理
                └── 提示用户重新扫码
```

### 心跳检查

桥接器每 30 秒执行一次心跳检查：

1. 检查 Gateway 连接状态
2. 检查微信服务状态
3. 检查微信登录状态
4. 记录检查结果到日志

### 消息重发

消息发送失败时的处理：

1. 重试 3 次
2. 每次重试间隔 1 秒
3. 仍失败则记录日志
4. 通知用户发送失败

---

## 性能考虑

### 连接复用

- Gateway 使用长连接 WebSocket
- 微信服务使用长连接 WebSocket
- 避免频繁创建/销毁连接

### 消息缓冲

```javascript
// 待发送消息队列
this.pendingMessages = new Map();

// 批量发送优化
async function flushMessages() {
  // 批量处理待发送消息
}
```

### 内存管理

- 限制消息历史记录数量
- 定期清理过期数据
- 日志文件自动轮转

---

## 安全设计

### 认证机制

| 组件 | 认证方式 |
|------|----------|
| 微信服务 | 授权码 (auth_key) |
| OpenClaw Gateway | Token (可选) |
| 管理操作 | 管理员密钥 (admin_key) |

### 数据加密

```
用户 --[MMTLS]--> 微信服务器
桥接器 --[HTTP/WS]--> 微信服务 (本地)
桥接器 --[WebSocket]--> Gateway (本地)
```

### 数据隐私

- 所有数据存储在本地
- 不经过第三方服务器
- 日志脱敏处理

### 权限控制

```
~/.openclaw/
├── openclaw-wechat.json    # 配置文件 (用户可读)
├── secrets/
│   └── wechat_auth_key     # 授权码 (仅用户可读)
└── logs/                   # 日志文件
```

---

## 扩展性

### 添加新功能

```javascript
// 1. 在 wechat.mjs 添加新的 API 方法
async newFeature(params) {
  // 实现逻辑
}

// 2. 在 bridge.mjs 添加处理逻辑
async handleNewFeature(data) {
  // 处理逻辑
}

// 3. 在 config.mjs 添加配置项
const DEFAULT_CONFIG = {
  newFeature: {
    enabled: true,
    // ...
  },
};
```

### 支持群聊

```javascript
// 修改消息处理逻辑
if (isChatRoom(message.from)) {
  // 群聊消息处理
  await handleGroupMessage(message);
} else {
  // 私聊消息处理
  await handlePrivateMessage(message);
}
```

---

**最后更新**: 2026-01-31
